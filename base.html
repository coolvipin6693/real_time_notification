<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Title Page</title>

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

		<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
		<link rel="stylesheet" href="./css/style.css">
	</head>
	<body>
		<nav class="navbar navbar-default" role="navigation" id="socialHeader">
			<div class="container">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="#">
						<img src="images/logo_sc.png" alt="">
					</a>
				</div>
		
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse navbar-ex1-collapse">
					<form class="navbar-form navbar-left askQuestion hide" role="search">
						<div class="form-group">
							<input type="text" class="form-control" placeholder="Ask a question" id="questionTextBox">
						</div>
						<button type="submit" class="btn btn-default questionAskBtn">Ask</button>
					</form>
					<ul class="nav navbar-nav navbar-right notif hide">
						<li class="button dropdown notificationList">
							<a href="javascript:;" data-toggle="dropdown" class="dropdown-toggle" aria-expanded="true" id="globeCounter"><i class="glyphicon glyphicon-globe"></i></a>
							<ul class="dropdown-menu notificationListItem">
								<li>
									<a href="#">
										<i class="fa fa-cloud-upload info"></i><b>Daniel</b> is now following you <span class="date">2 minutes ago.</span>
									</a>
								</li>
								<li>
									<a href="#">
										<i class="fa fa-cloud-upload info"></i><b>Daniel</b> is now following you <span class="date">2 minutes ago.</span>
									</a>
								</li>
								<li>
									<a href="#">
										<i class="fa fa-cloud-upload info"></i><b>Daniel</b> is now following you <span class="date">2 minutes ago.</span>
									</a>
								</li>
								<li>
									<a href="#">
										<i class="fa fa-cloud-upload info"></i><b>Daniel</b> is now following you <span class="date">2 minutes ago.</span>
									</a>
								</li>
							</ul>
						</li>
						<li class="hide" id="guestInfo">
							<a href="#">Welcome</a>
						</li>
						<li class="dropdown hide" id="userInfo">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">Rahul Khanna <b class="caret"></b></a>
							<ul class="dropdown-menu">
								<li><a href="#" id="logoutBtn">Logout</a></li>
							</ul>
						</li>
					</ul>
				</div><!-- /.navbar-collapse -->
			</div>
		</nav>


		<div id="loginSection" class="row hide">
			<div class="container">
				<div class="col-xs-6 col-xs-offset-3">
					<div class="panel">
						<div class="panel-heading">
							<h1>Access Social Cops</h1>
						</div>
						<div class="panel-body">
							<form method="POST" role="form" id="register" class="form-horizontal">
								<div class="form-group">
									<input type="email" class="form-control" id="emailInput" placeholder="Enter Email">
								</div>								
								<button type="button" class="btn btn-primary" id="registerBtn">Register</button>
								<button type="button" class="btn btn-info" id="loginBtn">Login</button>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>



		<section id="questionList" class="container hide">
			<div class="row">
				<div class="col-sm-8 col-sm-offset-2">
					<h4>Top Questions For You</h4>

					<div class="questionContainer">
						<div class="question">
							<p class="meta">
								Asked by : Yogi | March 31
							</p>
							<h2>
								<a href="#">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Porro quia accusamus amet corporis natus quae sint, alias iste et aspernatur.</a>
							</h2>
							<button class="btn btn-success answerBtn">Answer</button>
							<button class="btn btn-warning interestBtn">Interested</button>
							<button class="btn btn-warning hide notInterestBtn">Not Interested</button>
							<p class="answer">
								<span class="by">Rahul Khanna</span>
								Lorem ipsum dolor sit amet, consectetur adipisicing elit. Reiciendis ipsa iure quas tempore illo, pariatur unde nulla. Necessitatibus laboriosam magnam nemo cupiditate sit deleniti reprehenderit, minus, nostrum blanditiis omnis! Voluptatum!
							</p>
						</div>

						<div class="question">
							<p class="meta">
								Asked by : Yogi | March 31
							</p>
							<h2>
								<a href="#">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Porro quia accusamus amet corporis natus quae sint, alias iste et aspernatur.</a>
							</h2>
							<button class="btn btn-success answerBtn">Answer</button>
							<button class="btn btn-warning interestBtn">Interested</button>
							<button class="btn btn-warning hide notInterestBtn">Not Interested</button>
							<p class="answer">
								<span class="by">Rahul Khanna</span>
								Lorem ipsum dolor sit amet, consectetur adipisicing elit. Reiciendis ipsa iure quas tempore illo, pariatur unde nulla. Necessitatibus laboriosam magnam nemo cupiditate sit deleniti reprehenderit, minus, nostrum blanditiis omnis! Voluptatum!
							</p>
						</div>

						<div class="question">
							<p class="meta">
								Asked by : Yogi | March 31
							</p>
							<h2>
								<a href="#">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Porro quia accusamus amet corporis natus quae sint, alias iste et aspernatur.</a>
							</h2>
							<button class="btn btn-success answerBtn">Answer</button>
							<button class="btn btn-warning interestBtn">Interested</button>
							<button class="btn btn-warning hide notInterestBtn">Not Interested</button>
							<p class="answer">
								<span class="by">Rahul Khanna</span>
								Lorem ipsum dolor sit amet, consectetur adipisicing elit. Reiciendis ipsa iure quas tempore illo, pariatur unde nulla. Necessitatibus laboriosam magnam nemo cupiditate sit deleniti reprehenderit, minus, nostrum blanditiis omnis! Voluptatum!
							</p>
						</div>
					</div>
				</div>
			</div>
		</section>

		<div class="modal fade" tabindex="-1" role="dialog" id="answerModal">
			<div class="modal-dialog">
				<div class="modal-content">
					<form method="POST" role="form" id="postAnswer" class="form-horizontal">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">Post Answer</h4>
						</div>
						<div class="modal-body">
							<div class="form-group" style="margin: 0">
								<textarea name="answer" id="answerInput" rows="10" class="form-control"></textarea>
							</div>								
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
							<button type="button" class="btn btn-primary" id="postAnswerBtn">Post Answer</button>
						</div>
					</form>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

		<!-- jQuery -->
		<script src="http://code.jquery.com/jquery.js"></script>
		<script src="./js/notification.js"></script>
		<script src="./js/cookies.js"></script>
		<!-- Bootstrap JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
		<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
		<!-- Pusher script-->
		<script src="//js.pusher.com/3.0/pusher.min.js"></script>
		<!-- Pusher script ends-->
 		<script>

			$(document).ready(function() {
				var user = Cookies.get('userEmail');
				var counter = 0;
				if( user != undefined && user != '') {
					$('#userList').removeClass('hide');
					$('.askQuestion').removeClass('hide');
					$('.notif').removeClass('hide');
					$('#userEmail').html(user);
					$('#userInfo').html('<a href="#" class="dropdown-toggle" data-toggle="dropdown">'+user+'<b class="caret"></b></a><ul class="dropdown-menu"><li><a href="#" id="logoutBtn">Logout</a></li></ul>');
					$.ajax({
						type:'GET',
						url: 'http://localhost/gossip/api/getQuestionList/',
						data : {
							'user_id' : user
			     		},
						dataType : 'json',
						success : function(data){
							console.log("This is a test call");
							console.log(data);
							if(data.meta.status == 200) {
								var newHtml = '';
								var varUserAnswers = '';
								data.data.forEach(function(value, index) {

									value.answers.forEach(function(key, val){
										varUserAnswers +='<p class="answer"><span class="by">'+key.user_id+'</span>'+key.answer_string+'</p></br>';
									});

									newHtml += '<div class="question"><p class="meta">Asked by : '+value.asked_by_user+' | March 31</p>							<h2>								<a href="#">'+value.question_text+'</a>							</h2>							<button class="btn btn-success answerBtn" data-id="'+value.id+'">Answer</button><button class="btn btn-warning interestBtn" data-id="'+value.id+'">Interested</button><button class="btn btn-warning hide notInterestBtn">Not Interested</button>'+varUserAnswers+'</div>';

									var pusher = new Pusher('302a9c3ba67be4c3d5ee');
									var channel = pusher.subscribe(value.id);
									channel.bind('NEW_WATCHER_ADDED',function(data){
										alert("Put pg notification");
									});
									channel.bind('NEW_ANSWER',function(data){
										console.log(data);
										var questionId = data.message.answer_id.split("-")[1];
										var userId = data.message.answer_id.split("-")[0];
										var newHtml = '<li><a href="#"><i class="fa fa-cloud-upload info"></i><b>'+userId+'</b>has answered your question <span class="date">'+questionId+'</span></a></li>';
										counter = counter + 1;
										var globeHtml = '<i class="glyphicon glyphicon-globe"></i><span class="bubble">'+counter+'</span>';
										$("#globeCounter").html(globeHtml);
										$(".notificationListItem").html(newHtml);
									});
									channel.bind('EXISTING_ANSWER_MODIFIED',function(data){
										alert("Put pg notification");
								});
								});
								$('.questionContainer').html(newHtml);						
								$('#questionList').removeClass('hide');
								$('#userInfo').removeClass('hide');
							} else {
								var newHtml = '<div class="alert alert-info"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>Error in API</div>';
								$('.questionContainer').append(newHtml);
							}
						},
						error : function(jqXHR,textStatus,errorThrown){
							console.log('Error');
						}
					});
					
				} else {
					$('#guestInfo').removeClass('hide');
					$('#loginSection').removeClass('hide');
				}
				$('body').removeClass('hide');
			});


			$(document).ready(function() {
				$('#registerBtn').on('click', function(e) {

					e.preventDefault();
					console.log("test");
					userEmail = $('#emailInput').val();
					$.ajax({
						type:'POST',  
						url: 'http://localhost/gossip/api/registerUser',
						data : {
							'email_id' : userEmail
			     		},
						dataType : 'json',
						success : function(data){
							console.log('success');
							console.log(data);
						},
						error : function(jqXHR,textStatus,errorThrown){
							console.log('Error');
							console.log(errorThrown);
							console.log(textStatus);
							console.log(jqXHR);
						}
					});
					Cookies.set('userEmail', userEmail);
					location.reload();
				});

				$('#loginBtn').on('click', function(e) {
					e.preventDefault();
					userEmail = $('#emailInput').val();
					$.ajax({
						type:'POST',
						url: 'http://localhost/gossip/api/loginUser',
						data : {
							'email_id' : userEmail
			     		},
						dataType : 'json',
						success : function(data){
							if(data.meta.status == 200){
								Cookies.set('userEmail', userEmail);
								location.reload();							}
							else{
								console.log("Errorrrrrrr");
								}
						},
						error : function(jqXHR,textStatus,errorThrown){
							console.log('Error');
						}
					});

				});

				$('#logoutBtn').on('click', function(e) {
					e.preventDefault();
					Cookies.remove('userEmail');
					location.reload();
				});

			});

 			$(document).ready(function(e) {
 				$('#postAnswerBtn').on('click', function(e) {

					e.preventDefault();
					var user = Cookies.get('userEmail');
					console.log("Post answer modal");
					console.log(user);
					console.log(id);
					$.ajax({
						type:'POST',
						url: 'http://localhost/gossip/api/answerQuestion',
						data : {
							'user_id' : user,
							'question_id' : id,
							'answer_string' :$('#answerInput').val() 
			     		},
						dataType : 'json',
						success : function(data){
							if(data.meta.status == 200){
								console.log("Answer Submitted");
							}
							else{
								console.log("Answer not submitted");
							}
							
						},
						error : function(jqXHR,textStatus,errorThrown){
							console.log('Error');
						}
					});
					$('#answerModal').modal('hide');
 					$('body').pgNotification({"message":"Answer has been submitted", "type": 'success', "timeout": 4000}).show();
 				});

 				$(document).on('click', '.answerBtn', function(e) {
 					e.preventDefault();
 					id = $(this).attr('data-id');
 					$('#answerModal').modal();
 				});

 				$(document).on('click', '.interestBtn', function(e) {
				//$('.watch').on('click', function(e){
					e.preventDefault();
					var id = $(this).attr('data-id');
                    console.log(id+"");
                    console.log(Cookies.get('userEmail'));
					$.ajax({
						type:'POST',
						url: 'http://localhost/gossip/api/watchQuestion',
						data : {
							'user_id' : Cookies.get('userEmail'),
							'question_id' : id
			     		},
						dataType : 'json',
						success : function(data){
							
							var newHtml = "";
							if(data.status){

								var btn = $(this);
 								btn.addClass('hide').parent().find('.notInterestBtn').removeClass('hide');
 								$('body').pgNotification({"message":"Answer is marked as interested", "type": 'success', "timeout": 4000}).show();

								newHtml = '<div class="alert alert-info"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>Volla!!!</strong> This question is successully added to watch list.</div>';
					// $('#notificationSection').append(newHtml);

							}
							else{
								newHtml = '<div class="alert alert-info"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>Sorry!!!</strong> This question cannot be added to watch list.</div>';
					// $('#notificationSection').append(newHtml);
							}
							$('#notificationSection').append(newHtml);
						},
						error : function(jqXHR,textStatus,errorThrown){
							console.log('Error');
						}
					});

 				});

 				$('.notInterestBtn').on('click', function(e) {
 					e.preventDefault();
 					var btn = $(this);
 					btn.addClass('hide').parent().find('.interestBtn').removeClass('hide');
 					$('body').pgNotification({"message":"Answer is marked as not interested", "type": 'success', "timeout": 4000}).show();
 				});

 				$('#globeCounter').on('click', function(e) {
 					e.preventDefault();
 					counter = 0;
 					var globeHtml = '<i class="glyphicon glyphicon-globe"></i>';
					$("#globeCounter").html(globeHtml);
 					console.log("Clicked");
 				});

 				$('.questionAskBtn').on('click', function(e) {
 					e.preventDefault();
 					var questionText = $('#questionTextBox').val();
 					console.log(questionText);
 					console.log(questionText.trim().length);
 					if(questionText != null && questionText.trim().length != 0){

 						$.ajax({
						type:'POST',
						url: 'http://localhost/gossip/api/askQuestion',
						data : {
							'user_id' : Cookies.get('userEmail'),
							'question_string' : questionText,
							'category' : "Test"
			     		},
						dataType : 'json',
						success : function(data){
							if(data.meta.status == 200){
								console.log("Question Persisted");
								location.reload();
							}
							else{
								console.log("Question was not Persisted");
							}	
						},
						error : function(jqXHR,textStatus,errorThrown){
							console.log('Error');
						}
					});

 					}
 					else{
 						console.log("Question text is null or empty");
 					}
 				});

 			});

 		</script>
	</body>
</html>